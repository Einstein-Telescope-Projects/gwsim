stages:
  - test
  - coverage
  - release
  - publish

# Global variables and cache
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip
    - venv/

# ------------- Base Templates -------------

.test-template: &test-template
  stage: test
  before_script:
    - python -m pip install --upgrade pip setuptools wheel
    - python -m pip install -e .[test]
  script:
    - python -c "import gwsim; print('gwsim version:', gwsim.__version__)"
    - gwsim --help
    - export COVERAGE_FILE=.coverage.$CI_JOB_NAME
    - pytest
  artifacts:
    when: always
    paths:
      - .coverage.*
      - test-results.xml
      - coverage.xml
    reports:
      junit: test-results.xml
  only:
    - merge_requests
    - main
    - if: '$CI_COMMIT_TAG'

# ------------- Test Jobs -------------

test-python-3.10:
  <<: *test-template
  image: python:3.10

test-python-3.11:
  <<: *test-template
  image: python:3.11

test-python-3.12:
  <<: *test-template
  image: python:3.12

# ------------- Coverage Summary -------------

coverage-report:
  stage: coverage
  image: python:3.12
  before_script:
    - python -m pip install --upgrade pip
    - python -m pip install coverage[toml]
  script:
    - echo "Combining coverage reports from all Python versions"
    - coverage combine .coverage.*
    - coverage report --show-missing
    - coverage html
    - coverage xml
    - echo "Coverage report generated successfully"
  artifacts:
    when: always
    paths:
      - htmlcov/
      - coverage.xml
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
  needs:
    - test-python-3.10
    - test-python-3.11
    - test-python-3.12
  only:
    - merge_requests
    - main

publish_to_pypi:
  stage: publish
  image: python:3.12
  script:
    - pip install --upgrade poetry
    - poetry build
    # Publish to real PyPI
    - poetry config pypi-token.pypi $PYPI_PASSWORD
    - poetry publish --build
  rules:
    # Only run on semantic version tags (v1.2.3 or 1.2.3)
    - if: '$CI_COMMIT_TAG =~ /^v?\d+\.\d+\.\d+/'

publish_to_testpypi:
  stage: publish
  image: python:3.12
  script:
    - pip install --upgrade poetry
    - poetry build
    - poetry config repositories.testpypi https://test.pypi.org/legacy/
    - poetry config pypi-token.testpypi $TESTPYPI_PASSWORD
    - poetry publish --build -r testpypi
  rules:
    - if: '$CI_COMMIT_TAG =~ /-rc|-a|-b|-alpha|-beta/'   # pre-releases

create_gitlab_release:
  stage: release
  image: registry.gitlab.com/gitlab-org/cli:latest
  variables:
    GIT_DEPTH: 0  # Ensure full git history
  before_script:
    - apk add --no-cache jq curl  # Install dependencies
  script:
    - |
      # Get previous tag safely
      PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

      if [ -n "$PREV_TAG" ]; then
        echo "Generating changelog from $PREV_TAG to $CI_COMMIT_TAG"

        # Get timestamp of previous tag for API query
        PREV_TAG_DATE=$(git show -s --format=%aI $PREV_TAG)

        # Query GitLab API for merged MRs since previous tag
        MR_LIST=$(curl --silent --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
          "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests?state=merged&target_branch=main&updated_after=$PREV_TAG_DATE&per_page=100" \
          | jq -r '.[] | "• !\(.iid): \(.title)"' 2>/dev/null || echo "")

        # Parse conventional commits for additional context
        COMMIT_SUMMARY=$(git log $PREV_TAG..HEAD --oneline --no-merges | \
          grep -E '^[a-f0-9]+ (feat|fix|docs|style|refactor|perf|test|chore)(\(.+\))?: ' | \
          sed 's/^[a-f0-9]* \([^:]*\): \(.*\)/• \1: \2/' || echo "")

        # Combine MRs and notable commits
        if [ -n "$MR_LIST" ]; then
          CHANGELOG="### Merged Pull Requests\n$MR_LIST"
          if [ -n "$COMMIT_SUMMARY" ]; then
            CHANGELOG="$CHANGELOG\n\n### Notable Changes\n$COMMIT_SUMMARY"
          fi
        elif [ -n "$COMMIT_SUMMARY" ]; then
          CHANGELOG="### Changes\n$COMMIT_SUMMARY"
        else
          CHANGELOG="### Changes\n• Various improvements and bug fixes"
        fi
      else
        # First release - show project overview instead of all commits
        CHANGELOG="### Initial Release\n• First stable release of gwsim\n• Mock Data Challenge (MDC) generation for gravitational wave detectors\n• Support for noise, signal, and glitch simulation\n• Extensible simulator framework with PyCBC/LALSuite integration"
      fi

      # Save for use in release description
      echo -e "$CHANGELOG" > changelog.txt
  artifacts:
    paths:
      - changelog.txt
    expire_in: 1 hour
  release:
    name: "Release $CI_COMMIT_TAG"
    tag_name: '$CI_COMMIT_TAG'
    description: |
      ## What's Changed

      $(cat changelog.txt)

      ## Installation

      ```bash
      pip install gwsim==$CI_COMMIT_TAG
      ```

      ## Full Changelog

      **Compare:** [$PREV_TAG...$CI_COMMIT_TAG](https://gitlab.et-gw.eu/${CI_PROJECT_PATH}/-/compare/$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "HEAD~10")...$CI_COMMIT_TAG)
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v?\d+\.\d+\.\d+/'

docs_build_and_trigger_rtd:
  stage: publish
  image: python:3.12
  before_script:
    - pip install --upgrade pip
    - pip install poetry
    - poetry install --with docs          # make sure your pyproject.toml has [tool.poetry.group.docs]
  script:
    # 1. Build the HTML documentation locally
    - poetry run sphinx-build -b html docs/ site/
    # 2. Trigger Read the Docs webhook so it rebuilds instantly
    - curl -X POST -d "branches=main" -d "token=$RTD_WEBHOOK_TOKEN" \
           https://readthedocs.org/api/v2/webhook/${RTD_PROJECT_SLUG}/
  rules:
    # Run on every official release tag
    - if: '$CI_COMMIT_TAG =~ /^v?\d+\.\d+\.\d+/'
  artifacts:
    paths:
      - site/                 # mkdocs output folder (or docs/_build/html for Sphinx)
    expire_in: 1 day
